# coq-min-imports

This script will try to remove unnecessary module imports from _Coq_
sources. It examines modules listed in *"Require Import"* statements
one by one and tries to recompile to see if their removal would cause
compilation errors.

## Running

The easy way to run it is to replace __COQC__ variable in *Makefile*
generated by *coq_makefile*. This can be done by adding this to
`CoqMakefile.local`:

    COQC=coq-min-imports -cmi-verbose -cmi-wrap

And run the *make*. For each *.v* file where some imports where
removed, a modified version will be saved with *.v.new* extension. If
want to overwrite *.v* files rather than generate new versions, use
*-cmi-replace* option.

Sometimes removing an import will not cause the compilation to fail
immediately but rather makes *coqc* to run for a very long time. One
workaround is to add a timeout to coqc invocation. This could be done
using _timeout(1)_ shell wrapper. For example, using the following
command line option with *coq-min-imports*: *`-cmi-coqc="timeout 10s
coqc"`* will impose 10 seconds compilation timout.

## Example:

    $ coq-min-imports -cmi-verbose -cmi-wrap  -q  -R "." Top -I "."   CarrierType.v
    Processing CarrierType.v
        -MathClasses.orders.orders
        +MathClasses.interfaces.orders
        +MathClasses.theory.rings
        +MathClasses.interfaces.abstract_algebra
        +CoLoR.Util.Vector.VecUtil
        -Ring
        -Coq.Bool.Bool
    Writing modified copy of CarrierType.v as CarrierType.v.new with 3 imports removed

In the verbose mode, used above, it prints each imported module it
attempts to remove. Modules marked with __+__ could not be removed,
and modules marked with __-__ will be removed.

## Usage: 

    coq-min-imports <coq_flags> [-cmi-verbose] [-cmi-replace] [-cmi-wrap] <files...>

where

* *__&lt;coq_flags>__* - any of optoins supported by *'coqc'*
* *__&lt;files>__* - list of *.v* files to process
* __-cmi-verbose__ - enable verbose reporting
* __-cmi-replace__ - replace processed files with optmized versions (orignals are saved with the *".bak"* suffix). Otherwise, the optimized versions are written as a new files with the same name as the input but adding *".new"* suffix
* __-cmi-wrap__ - run in a coqc-wrapper mode, compiling the files as the side-effect
* __-cmi-coqc=*&lt;command>*__ - use the *&lt;command>* instead of *coqc*


## Author

Vadim Zaliva <lord@crocodile.org>
